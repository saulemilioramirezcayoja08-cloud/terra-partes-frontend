<div class="order-list-component">
  <div class="row">
    <div class="row">
      <div class="title">Listar Órdenes</div>
      <div class="subtitle">Visualiza y filtra todas las órdenes registradas</div>
    </div>

    @if (errorMessage()) {
      <div class="error-message">
        {{ errorMessage() }}
      </div>
    }

    <div class="row">
      <div class="col">
        <div class="row">
          <div>
            <label>Desde</label>
            <input type="date" [(ngModel)]="filterStartDate">
          </div>
          <div>
            <label>Hasta</label>
            <input type="date" [(ngModel)]="filterEndDate">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Usuario</label>
            <input type="text" placeholder="Ej: EMILIO RAMIREZ" [(ngModel)]="filterUsername">
          </div>
          <div>
            <label>Notas</label>
            <input type="text" placeholder="Ej: urgente, entrega" [(ngModel)]="filterNotes">
          </div>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <div>
            <label>Número de orden</label>
            <input type="text" placeholder="Ej: 1, 2024-001" [(ngModel)]="filterNumber">
          </div>
          <div>
            <label>Nombre del cliente</label>
            <input type="text" placeholder="Ej: Juan Pérez" [(ngModel)]="filterCustomerName">
          </div>
        </div>
        <div class="row"></div>
      </div>
      <div class="col">
        <div class="row">
          <div>
            <label>Almacén</label>
            <input type="text" placeholder="Ej: Central, Norte" [(ngModel)]="filterWarehouse">
          </div>
          <div>
            <label>Método de pago</label>
            <input type="text" placeholder="Ej: Efectivo, Tarjeta" [(ngModel)]="filterPaymentName">
          </div>
        </div>
        <div class="row"></div>
      </div>
    </div>
    <div class="row">
      <button (click)="search()" [disabled]="isLoading()">Buscar</button>
      <button (click)="clear()">Limpiar</button>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>NÚMERO</th>
            <th>ESTADO</th>
            <th>FECHA</th>
            <th>USUARIO</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
            @if (orders().length === 0 && !isLoading()) {
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px;">
                  No se encontraron órdenes
                </td>
              </tr>
            }
            @for (order of orders(); track order.id) {
              <tr [class.selected]="selectedOrder()?.id === order.id" (click)="selectOrder(order)">
                <td>{{ order.id }}</td>
                <td>{{ order.number }}</td>
                <td>{{ order.status }}</td>
                <td>{{ formatDate(order.createdAt) }}</td>
                <td>{{ order.user?.username || 'N/A' }}</td>
                <td>
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                      <path
                        d="M20.9983 10C20.9862 7.82497 20.8897 6.64706 20.1213 5.87868C19.2426 5 17.8284 5 15 5H12C9.17157 5 7.75736 5 6.87868 5.87868C6 6.75736 6 8.17157 6 11V16C6 18.8284 6 20.2426 6.87868 21.1213C7.75736 22 9.17157 22 12 22H15C17.8284 22 19.2426 22 20.1213 21.1213C21 20.2426 21 18.8284 21 16V15"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                      <path
                        d="M3 10V16C3 17.6569 4.34315 19 6 19M18 5C18 3.34315 16.6569 2 15 2H11C7.22876 2 5.34315 2 4.17157 3.17157C3.51839 3.82475 3.22937 4.69989 3.10149 6"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    </g>
                  </svg>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div class="pagination-info">
          <span>Página {{ currentPage() + 1 }} de {{ totalPages() }}</span>
          <span class="separator">|</span>
          <span>{{ totalElements() }} órdenes en total</span>
        </div>
        <div class="pagination-controls">
          <button
            [disabled]="!hasPrevious() || isLoading()"
            (click)="previousPage()">
            Anterior
          </button>
          <button
            [disabled]="!hasNext() || isLoading()"
            (click)="nextPage()">
            Siguiente
          </button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>SKU</th>
            <th>PRODUCTO</th>
            <th>CANTIDAD</th>
            <th>PRECIO</th>
          </tr>
          </thead>
          <tbody>
            @if (!selectedOrder()) {
              <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">
                  Seleccione una orden para ver sus detalles
                </td>
              </tr>
            } @else if (selectedOrder()!.details.length === 0) {
              <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">
                  Esta orden no tiene productos
                </td>
              </tr>
            } @else {
              @for (detail of selectedOrder()!.details; track detail.id) {
                <tr>
                  <td>{{ detail.product.sku }}</td>
                  <td>{{ detail.product.name }}</td>
                  <td>{{ detail.quantity }}</td>
                  <td>{{ detail.price.toFixed(2) }}</td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      @if (selectedOrder()) {
        <div class="totals-container">
          <table>
            <tfoot>
            <tr class="totals-row">
              <td colspan="2" class="totals-label">TOTAL DE PRODUCTOS:</td>
              <td colspan="2" class="totals-value">{{ selectedOrder()!.totals.productCount }}</td>
            </tr>
            <tr class="totals-row">
              <td colspan="2" class="totals-label">TOTAL PAGADO:</td>
              <td colspan="2" class="totals-value">Bs. {{ selectedOrder()!.totals.totalPayments.toFixed(2) }}</td>
            </tr>
            <tr class="totals-row">
              <td colspan="2" class="totals-label">SALDO PENDIENTE:</td>
              <td colspan="2" class="totals-value">Bs. {{ selectedOrder()!.totals.pendingAmount.toFixed(2) }}</td>
            </tr>
            </tfoot>
          </table>
        </div>
      }
    </div>
  </div>
</div>
