<div class="order-create-component">
  <div class="row">
    <div class="title">Crear Orden</div>
    <div class="subtitle">
      completa los datos para generar una orden • <kbd>ESC</kbd> volver • <kbd>Ctrl+Shift+P</kbd> agregar producto
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="row">
        <div class="col">
          <label>
            <span class="label-text">Cliente</span>
            <kbd>Ctrl+Shift+C</kbd>
          </label>
          <div class="input-wrapper">
            <input type="text" class="data-input clickable"
              [value]="cart().customer.id ? cart().customer.name : 'Sin seleccionar'" readonly
              [class.empty]="cart().customer.id === 0" (click)="toggleCustomerDropdown($event)">

            @if (showCustomerDropdown()) {
            <div class="dropdown-menu" (click)="$event.stopPropagation()">
              <div class="dropdown-search">
                <input type="text" class="search-input" placeholder="Buscar cliente..." [ngModel]="customerSearch()"
                  (ngModelChange)="customerSearch.set($event)" (click)="$event.stopPropagation()">
              </div>

              <div class="dropdown-items">
                @if (filteredCustomers().length === 0) {
                <div class="dropdown-empty">No se encontraron clientes</div>
                }

                @for (customer of filteredCustomers(); track trackByCustomerId($index, customer)) {
                <div class="dropdown-item" (click)="selectCustomerFromDropdown(customer, $event)">
                  <span class="customer-name">{{ customer.name }}</span>
                  <span class="customer-detail">NIT: {{ customer.taxId }}</span>
                </div>
                }
              </div>
            </div>
            }
          </div>

          <label>
            <span class="label-text">Almacén</span>
            <kbd>Ctrl+Shift+A</kbd>
          </label>
          <div class="input-wrapper">
            <input type="text" class="data-input clickable"
              [value]="cart().warehouse.id ? cart().warehouse.name : 'Sin seleccionar'" readonly
              [class.empty]="cart().warehouse.id === 0" (click)="toggleWarehouseDropdown($event)">

            @if (showWarehouseDropdown()) {
            <div class="dropdown-menu" (click)="$event.stopPropagation()">
              <div class="dropdown-search">
                <input type="text" class="search-input" placeholder="Buscar almacén..." [ngModel]="warehouseSearch()"
                  (ngModelChange)="warehouseSearch.set($event)" (click)="$event.stopPropagation()">
              </div>

              <div class="dropdown-items">
                @if (filteredWarehouses().length === 0) {
                <div class="dropdown-empty">No se encontraron almacenes</div>
                }

                @for (warehouse of filteredWarehouses(); track trackByWarehouseId($index, warehouse)) {
                <div class="dropdown-item" (click)="selectWarehouseFromDropdown(warehouse, $event)">
                  <span class="customer-name">{{ warehouse.name }}</span>
                  <span class="customer-detail">Código: {{ warehouse.code }}</span>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>

        <div class="col">
          <label>
            <span class="label-text">Forma de pago</span>
            <kbd>Ctrl+Shift+M</kbd>
          </label>
          <div class="input-wrapper">
            <input type="text" class="data-input clickable"
              [value]="cart().payment.id ? cart().payment.name : 'Sin seleccionar'" readonly
              [class.empty]="cart().payment.id === 0" (click)="togglePaymentDropdown($event)">

            @if (showPaymentDropdown()) {
            <div class="dropdown-menu" (click)="$event.stopPropagation()">
              <div class="dropdown-search">
                <input type="text" class="search-input" placeholder="Buscar método de pago..."
                  [ngModel]="paymentSearch()" (ngModelChange)="paymentSearch.set($event)"
                  (click)="$event.stopPropagation()">
              </div>

              <div class="dropdown-items">
                @if (filteredPayments().length === 0) {
                <div class="dropdown-empty">No se encontraron métodos de pago</div>
                }

                @for (payment of filteredPayments(); track trackByPaymentId($index, payment)) {
                <div class="dropdown-item" (click)="selectPaymentFromDropdown(payment, $event)">
                  <span class="customer-name">{{ payment.name }}</span>
                  <span class="customer-detail">Código: {{ payment.code }}</span>
                </div>
                }
              </div>
            </div>
            }
          </div>

          <label>
            <span class="label-text">Moneda</span>
          </label>
          <input type="text" class="data-input" [value]="cart().currency" disabled>
        </div>
      </div>

      @if (hasWarnings() && itemCount() > 0) {
      <div class="row warning-banner">
        <span>{{ warningMessage() }}</span>
      </div>
      }

      <div class="row">
        @if (details().length > 0) {
        <table>
          <thead>
            <tr>
              <th></th>
              <th>COD INT.</th>
              <th>CANT.</th>
              <th>DESCRIPCIÓN</th>
              <th>PRECIO</th>
              <th>SUBTOTAL</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (detail of details(); track trackByProductId($index, detail); let i = $index) {
            <tr>
              <td>{{ i + 1 }}</td>
              <td>{{ detail.sku }}</td>
              <td>
                <input type="number" [ngModel]="detail.quantity"
                  (ngModelChange)="updateDetailQuantity(detail.productId, $event)" class="input-cell" min="1">
              </td>
              <td>
                <input type="text" [ngModel]="detail.editableName || detail.name"
                  (ngModelChange)="updateDetailName(detail.productId, $event)" class="input-cell">
              </td>
              <td>
                <input type="number" [ngModel]="detail.price"
                  (ngModelChange)="updateDetailPrice(detail.productId, $event)" class="input-cell" step="0.01" min="0">
              </td>
              <td>Bs. {{ detail.subtotal | number:'1.2-2' }}</td>
              <td>
                <svg (click)="removeDetail(detail.productId)" viewBox="0 0 24 24" fill="none"
                  xmlns="http://www.w3.org/2000/svg">
                  <g id="SVGRepo_iconCarrier">
                    <path d="M20.5001 6H3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    <path
                      d="M6.5 6C6.55588 6 6.58382 6 6.60915 5.99936C7.43259 5.97849 8.15902 5.45491 8.43922 4.68032C8.44784 4.65649 8.45667 4.62999 8.47434 4.57697L8.57143 4.28571C8.65431 4.03708 8.69575 3.91276 8.75071 3.8072C8.97001 3.38607 9.37574 3.09364 9.84461 3.01877C9.96213 3 10.0932 3 10.3553 3H13.6447C13.9068 3 14.0379 3 14.1554 3.01877C14.6243 3.09364 15.03 3.38607 15.2493 3.8072C15.3043 3.91276 15.3457 4.03708 15.4286 4.28571L15.5257 4.57697C15.5433 4.62992 15.5522 4.65651 15.5608 4.68032C15.841 5.45491 16.5674 5.97849 17.3909 5.99936C17.4162 6 17.4441 6 17.5 6"
                      stroke="currentColor" stroke-width="1.5"></path>
                    <path
                      d="M18.3735 15.3991C18.1965 18.054 18.108 19.3815 17.243 20.1907C16.378 21 15.0476 21 12.3868 21H11.6134C8.9526 21 7.6222 21 6.75719 20.1907C5.89218 19.3815 5.80368 18.054 5.62669 15.3991L5.16675 8.5M18.8334 8.5L18.6334 11.5"
                      stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                  </g>
                </svg>
              </td>
            </tr>
            <tr class="notes-row">
              <td colspan="7">
                <input type="text" [ngModel]="detail.notes || ''"
                  (ngModelChange)="updateDetailNotes(detail.productId, $event)" class="notes-cell"
                  placeholder="Notas del producto (opcional)...">
              </td>
            </tr>
            }
          </tbody>
        </table>
        } @else {
        <div class="empty-state">
          <p>No hay productos en la orden</p>
          <p>Presiona <kbd>Ctrl+Shift+P</kbd> para agregar productos</p>
        </div>
        }
      </div>

      <div class="row pagination">
        <div class="col">
          <button (click)="router.navigate(['/order/select-product'])">
            Agregar producto
          </button>
        </div>

        <div class="col">
          <button (click)="previewOrder()">Previsualizar</button>
          <span class="separator">|</span>
          <button (click)="viewLastOrder()">Ver última</button>
          <span class="separator">|</span>
          <button (click)="clearAll()">Limpiar</button>
          <span class="separator">|</span>
          <button (click)="createOrder()" class="primary" [disabled]="!canSave()" [title]="saveBlockReason()">
            Guardar orden
          </button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="row">
        <div class="col">
          <div class="title">Resumen</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Estado</div>
          <span>BORRADOR</span>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Items</div>
          <strong>{{ itemCount() }}</strong>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Total</div>
          <strong>Bs. {{ total() | number:'1.2-2' }}</strong>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Anticipo</div>
          <input type="number" [ngModel]="paymentModel()" (ngModelChange)="updatePaymentAmount($event)"
            class="payment-input" step="0.01" min="0" [max]="total()" placeholder="0.00">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Saldo</div>
          <mark [class.negative]="pending() < 0">Bs. {{ pending() | number:'1.2-2' }}</mark>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="subtitle">Notas</div>
          <textarea rows="3" [ngModel]="notesModel()" (ngModelChange)="updateOrderNotes($event)"
            placeholder="Observaciones..." class="notes-input"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>