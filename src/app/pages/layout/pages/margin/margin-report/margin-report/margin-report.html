<div class="margin-report-component">
  <div class="row">
    <div class="title">Análisis de Margen Bruto</div>
    <div class="subtitle">
      Rentabilidad por producto • Excluye ventas/compras a crédito • <kbd>Enter</kbd> para buscar
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="row filters-container">
        <div class="col filters-left">
          <div class="date-row">
            <div class="date-group">
              <label>Desde</label>
              <input
                type="date"
                class="date-input"
                [ngModel]="startDate()"
                (ngModelChange)="startDate.set($event)"
                (keyup.enter)="onEnter()">
            </div>
            <div class="date-group">
              <label>Hasta</label>
              <input
                type="date"
                class="date-input"
                [ngModel]="endDate()"
                (ngModelChange)="endDate.set($event)"
                (keyup.enter)="onEnter()">
            </div>
          </div>
          
          <div class="search-row">
            <input
              type="text"
              class="search-input"
              placeholder="Buscar por usuario..."
              [ngModel]="searchUsername()"
              (ngModelChange)="searchUsername.set($event)"
              (keyup.enter)="onEnter()"
              autocomplete="off">
            <div class="search-hint">
              Busca por nombre de usuario • <kbd>Enter</kbd> buscar
            </div>
          </div>
        </div>

        <div class="col filters-right">
          <button class="btn-search" (click)="onSearch()">Generar Reporte</button>
          <button class="btn-clear" (click)="clearFilters()">Limpiar</button>
        </div>
      </div>

      @if (summary(); as sum) {
        <div class="row summary-cards">
          <div class="summary-card">
            <div class="card-label">Ventas Totales</div>
            <div class="card-value sales">Bs. {{ sum.totalSalesRevenue | number:'1.2-2' }}</div>
          </div>

          <div class="summary-card">
            <div class="card-label">Compras Totales</div>
            <div class="card-value purchases">Bs. {{ sum.totalPurchaseCost | number:'1.2-2' }}</div>
          </div>

          <div class="summary-card highlight">
            <div class="card-label">Margen Bruto</div>
            <div class="card-value margin" [class.negative]="!hasPositiveMargin()">
              Bs. {{ sum.totalProfit | number:'1.2-2' }}
            </div>
          </div>

          <div class="summary-card highlight">
            <div class="card-label">% Margen</div>
            <div class="card-value margin-percent" [class.negative]="!hasPositiveMargin()">
              {{ sum.averageMarginPercentage | number:'1.2-2' }}%
            </div>
          </div>
        </div>
      }

      <div class="row">
        <table>
          <thead>
          <tr>
            <th>SKU</th>
            <th>PRODUCTO</th>
            <th>VENDIDO</th>
            <th>COMPRADO</th>
            <th>MARGEN</th>
            <th>%</th>
          </tr>
          </thead>
          <tbody>
            @if (isLoading()) {
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px;">
                  <em>Cargando...</em>
                </td>
              </tr>
            } @else if (products().length === 0) {
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px;">
                  <em>No hay productos con movimiento en el período seleccionado</em>
                </td>
              </tr>
            } @else {
              @for (product of products(); track trackByProductId($index, product)) {
                <tr
                  (click)="selectProduct(product)"
                  [class.selected]="selectedProduct()?.productId === product.productId">
                  <td>{{ product.sku }}</td>
                  <td>{{ product.name }}</td>
                  <td>Bs. {{ product.sales.totalRevenue | number:'1.2-2' }}</td>
                  <td>Bs. {{ product.purchases.totalCost | number:'1.2-2' }}</td>
                  <td [class]="getMarginClass(product.margin.profitPercentage)">
                    Bs. {{ product.margin.totalProfit | number:'1.2-2' }}
                  </td>
                  <td [class]="getMarginClass(product.margin.profitPercentage)">
                    {{ product.margin.profitPercentage | number:'1.2-2' }}%
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <div class="row result-info">
        <span>{{ resultInfo() }}</span>
      </div>
    </div>

    <div class="col">
      @if (selectedProduct(); as product) {
        <div class="row">
          <div class="col">
            <div class="title">Detalle del Producto</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="subtitle">Nombre</div>
            <span>{{ product.name }}</span>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="title">Ventas</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="subtitle">Cantidad vendida</div>
            <span>{{ product.sales.totalUnits }} unidades</span>
          </div>
          <div class="col">
            <div class="subtitle">Monto vendido</div>
            <strong>Bs. {{ product.sales.totalRevenue | number:'1.2-2' }}</strong>
          </div>
        </div>
        
        <div class="row">
          <div class="col">
            <div class="subtitle">Transacciones</div>
            <span>{{ product.sales.transactions }} ventas</span>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="title">Compras</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="subtitle">Cantidad comprada</div>
            <span>{{ product.purchases.totalUnits }} unidades</span>
          </div>
          <div class="col">
            <div class="subtitle">Monto comprado</div>
            <strong>Bs. {{ product.purchases.totalCost | number:'1.2-2' }}</strong>
          </div>
        </div>
        
        <div class="row">
          <div class="col">
            <div class="subtitle">Transacciones</div>
            <span>{{ product.purchases.transactions }} compras</span>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="title">Rentabilidad</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="subtitle">Margen bruto</div>
            <mark [class]="getMarginClass(product.margin.profitPercentage)">
              Bs. {{ product.margin.totalProfit | number:'1.2-2' }}
            </mark>
          </div>
          <div class="col">
            <div class="subtitle">Porcentaje</div>
            <mark [class]="getMarginClass(product.margin.profitPercentage)">
              {{ product.margin.profitPercentage | number:'1.2-2' }}%
            </mark>
          </div>
        </div>

      } @else {
        <div class="row">
          <div class="col" style="padding: 40px; text-align: center;">
            <em>Selecciona un producto para ver su análisis detallado</em>
          </div>
        </div>
      }
    </div>
  </div>
</div>